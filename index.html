<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>インタラクティブ医療説明動画（統合版）</title>
  <style>
    :root{
      --max-width:900px;
      --btn-max-width:120px;
    }
    body{
      margin:0;
      background:#000;
      display:flex;
      justify-content:center;
      align-items:center;
      min-height:100vh;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
    }
    .stage{
      position:relative;
      width:100%;
      max-width:var(--max-width);
      aspect-ratio:16/9;
      background:#111;
      overflow:hidden;
    }
    video, img {
      width:100%;
      height:100%;
      object-fit:cover;
      display:none;
      user-select:none;
    }
    /* ボタン共通 */
    .btn{
      pointer-events:auto;
      background:rgba(255,255,255,0.95);
      border-radius:12px;
      padding:12px 18px;
      font-size:16px;
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }
    /* 開始・スキップボタン */
    #startOverlay{
      position:absolute; inset:0;
      display:flex; justify-content:center; align-items:center;
      z-index:20;
    }
    #skipBtn{
      position:absolute; top:10px; right:10px; z-index:25; display:none;
    }
    /* マップ */
    #mapBg{ display:none; position:absolute; top:0; left:0; width:100%; height:100%; }
    .map-button{
      position:absolute;
      transform:translate(-50%,-50%);
      display:none;
      cursor:pointer;
      touch-action:manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .map-button img{
      display:block;
      width:80%;
      max-width:var(--btn-max-width);
      height:auto;
      user-drag:none;
    }
    .map-button:hover { transform:translate(-50%,-50%) scale(1.05); }

    /* 説明動画 */
    #explainVideo{
      display:none;
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      object-fit:contain;
      background:#000;
    }
    /* 動画中にマップに戻るボタン */
    #backDuring{
      position:absolute;
      top:10px; right:10px;
      display:none; z-index:30;
    }
    /* 終了後操作 */
    .controls{
      position:absolute; bottom:6%; left:50%;
      transform:translateX(-50%);
      display:none; gap:10px; z-index:30;
    }
    .controls button{ padding:10px 16px; border:none; border-radius:8px; background:rgba(255,255,255,0.95); cursor:pointer; }

    /* プロローグ */
    #prologueVideo{ display:block; width:100%; height:100%; object-fit:cover; }

    @media (max-width:480px){
      .map-button img{ width:50%; }
      .controls button{ font-size:15px; padding:10px 14px; }
    }
  </style>
</head>
<body>
<div class="stage" id="stage">
  <!-- プロローグ -->
  <video id="prologueVideo" playsinline webkit-playsinline>
    <source src="prologue.mp4" type="video/mp4">
  </video>
  <div id="startOverlay"><button class="btn" id="startButton">▶ 開始する</button></div>
  <button class="btn" id="skipBtn">スキップ</button>

  <!-- マップ -->
  <img id="mapBg" src="map.png" alt="マップ">
  <div id="building1" class="map-button" style="top:52%; left:48%;"><img src="building1.png"></div>
  <div id="building2" class="map-button" style="top:39%; left:15.5%;"><img src="building2.png"></div>
  <div id="building3" class="map-button" style="top:28%; left:81%;"><img src="building3.png"></div>

  <!-- 説明動画 -->
  <video id="explainVideo" controls playsinline webkit-playsinline></video>
  <button id="backDuring" class="btn">マップに戻る</button>

  <!-- 終了後の操作 -->
  <div class="controls" id="controlButtons">
    <button id="backBtn" class="btn">マップに戻る</button>
    <button id="replayBtn" class="btn">見直す</button>
  </div>
</div>

<script>
const prologueVideo = document.getElementById('prologueVideo');
const startOverlay = document.getElementById('startOverlay');
const startButton = document.getElementById('startButton');
const skipBtn = document.getElementById('skipBtn');
const mapBg = document.getElementById('mapBg');
const buildings = [
  { el: document.getElementById('building1'), video: 'video1.mp4' },
  { el: document.getElementById('building2'), video: 'video2.mp4' },
  { el: document.getElementById('building3'), video: 'video3.mp4' },
];
const explainVideo = document.getElementById('explainVideo');
const backDuring = document.getElementById('backDuring');
const controlButtons = document.getElementById('controlButtons');
const backBtn = document.getElementById('backBtn');
const replayBtn = document.getElementById('replayBtn');

// ドラッグ防止
document.querySelectorAll('img').forEach(img => img.addEventListener('dragstart', e => e.preventDefault()));

// 開始ボタン
startButton.addEventListener('click', async () => {
  startOverlay.style.display = 'none';
  skipBtn.style.display = 'block';
  prologueVideo.style.display = 'block';
  try{ await prologueVideo.play(); } catch(e){ console.warn(e); }
});

// スキップボタン
skipBtn.addEventListener('click', showMenu);

// プロローグ終了後
prologueVideo.addEventListener('ended', showMenu);

function showMenu(){
  prologueVideo.pause();
  prologueVideo.style.display = 'none';
  skipBtn.style.display = 'none';
  explainVideo.style.display = 'none';
  backDuring.style.display = 'none';
  controlButtons.style.display = 'none';
  mapBg.style.display = 'block';
  buildings.forEach(b => b.el.style.display = 'block');
  explainVideo.src = '';
}

// 建物クリック → 確認 → 動画再生
buildings.forEach(b => {
  const playFunc = () => {
    if(confirm("この動画を再生しますか？\nキャンセルで他を選べます")) playExplain(b.video);
  };
  b.el.addEventListener('click', playFunc);
  b.el.addEventListener('touchend', playFunc); // タッチ対応
});


async function playExplain(src){
  mapBg.style.display = 'none';
  buildings.forEach(b => b.el.style.display = 'none');
  controlButtons.style.display = 'none';
  explainVideo.src = src;
  explainVideo.load();
  explainVideo.style.display = 'block';
  backDuring.style.display = 'block';
  explainVideo.currentTime = 0;
  try{ await explainVideo.play(); } catch(e){ console.warn(e); }
}

// 動画中にマップに戻る
backDuring.addEventListener('click', () => {
  explainVideo.pause();
  explainVideo.style.display = 'none';
  backDuring.style.display = 'none';
  showMenu();
});

// 動画終了後に操作ボタン表示
explainVideo.addEventListener('ended', () => {
  backDuring.style.display = 'none';
  controlButtons.style.display = 'flex';
});

// 見直す
replayBtn.addEventListener('click', () => {
  controlButtons.style.display = 'none';
  explainVideo.currentTime = 0;
  explainVideo.play();
});

// マップに戻る
backBtn.addEventListener('click', () => {
  explainVideo.pause();
  explainVideo.style.display = 'none';
  backDuring.style.display = 'none';
  controlButtons.style.display = 'none';
  showMenu();
});
</script>
</body>
</html>